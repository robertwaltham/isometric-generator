<!DOCTYPE HTML>
<html>
<head>
    <title>Generator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
        }
    </style>
    <script src="resources/pixi.dev.js"></script>
    <script src="resources/jquery-2.1.1.js"></script>
    <script src="resources/jquery-ui-1.11.1/jquery-ui.js"></script>
    <link href="resources/jquery-ui-1.11.1/jquery-ui.css" rel="stylesheet" type="text/css" title="Jquery UI">
    <link href="resources/jquery-ui-1.11.1/jquery-ui.css" rel="stylesheet" type="text/css" title="Jquery UI">
    <link href="resources/jquery-ui-1.11.1/jquery-ui.structure.css" rel="stylesheet" type="text/css" title="Jquery UI">
    <link href="resources/jquery-ui-1.11.1/jquery-ui.theme.css" rel="stylesheet" type="text/css" title="Jquery UI">

</head>
<body>

<script>

    var Generator = {
        options:{
            tile_count_x:25,
            tile_count_y:25,
            tile_half_x: 20,
            tile_half_y: 10,
            tile_base_scale: 0.4,
            offset_x: 640,
            offset_y: 64,
            canvas_width: 1280,
            canvas_height: 900,
            sprite_anchor: 0.5,
            texture_paths:{
                dirt:"resources/road/dirt.png",
                grass:"resources/road/grass.png",
                lot:"resources/road/lot.png"
            },
            texture_index:['dirt', 'grass', 'lot']
        },
        textures:[],
        tiles:[],
        sprites:[],
        highlightedTile:null,
        text:{
            fps:null,
            click:null
        },
        time:0,
        frame_count:0,
        stage:null,
        renderer:null,
        init:function(options){
            // extend options
            $.extend(this.options, {}, options);

            console.log(this.options);

            // load textures
            for(var key in this.options.texture_paths){
                this.textures[key] = PIXI.Texture.fromImage(this.options.texture_paths[key]);
            }

            // generate tiles

            var path = [{x:0,y:0}, {x:1,y:0}, {x:1,y:1}, {x:1,y:2}];

            //this.lib.addPath(this.tiles, path, 'grass');


            // create an new instance of a pixi stage
            this.stage = new PIXI.Stage(0x66FF99, true);
            this.stage.interactive = true;

            this.tiles = this.lib.generateTiles(this.options, this.stage);
            console.log(this.tiles);

            this.text.fps = new PIXI.Text("-", {font:"26px Arial", fill:"black"});
            this.text.click = new PIXI.Text("-", {font:"26px Arial", fill:"black"});
            this.text.click.position.y = 30;

            this.stage.mousedown = function(data){
                var pos = this.getMousePosition();
                var tile = Generator.lib.isometricToOrtho(pos.x, pos.y,
                        Generator.options.tile_half_x,
                        Generator.options.tile_half_y,
                        Generator.options.offset_x,
                        Generator.options.offset_y,
                        Generator.options.sprite_anchor);
                if(tile.x > -1 && tile.y > -1 && tile.x < Generator.options.tile_count_x && tile.y < Generator.options.tile_count_y){
                    Generator.text.click.setText('x: ' + tile.x + ' y:' + tile.y);
                    if(this.highlightedTile){
                        this.highlightedTile.sprite.alpha = 1.0;
                    }
                    this.highlightedTile = Generator.tiles[tile.x][tile.y];
                    this.highlightedTile.sprite.alpha = 0.5;
                }
            };

            this.stage.addChild(this.text.fps);
            this.stage.addChild(this.text.click);

            this.renderer = PIXI.autoDetectRenderer(this.options.canvas_width, this.options.canvas_height);

            // add the renderer view element to the DOM
            document.body.appendChild(this.renderer.view);

            this.time = Date.now();
            // set up renderer
            requestAnimFrame(this.lib.animate);

        },
        obj:{
            Tile:function(options, texture_def, x, y){
                this.sprite = Generator.lib.spriteFactory(options, Generator.textures[texture_def], x, y);
                this.x = x;
                this.y = y;
            }
        },
        lib:{
            generateTiles:function(options, stage){
                var tiles = [];
                for(var x = 0; x < options.tile_count_x; x++){
                    var col = [];
                    for (var y = 0; y < options.tile_count_y; y++){
                        var tile = new Generator.obj.Tile(options, 'grass', x, y);
                        col[y] = tile;
                        stage.addChild(tile.sprite);
                    }
                    tiles[x] = col;
                }
                return tiles;
            },
            spriteFactory:function(options, texture, x, y){
                var sprite = new PIXI.Sprite(texture);
                // center the sprites anchor point
                sprite.anchor.x = options.sprite_anchor;
                sprite.anchor.y = options.sprite_anchor;

                sprite.position = Generator.lib.orthoToIsometric(x, y,
                        options.tile_half_x,
                        options.tile_half_y,
                        options.offset_x,
                        options.offset_y);

                sprite.scale = new PIXI.Point(options.tile_base_scale, options.tile_base_scale);

                return sprite;
            },
            addPath: function (tiles, path, texture) {
                for (var index in path) {
                    var path_node = path[index];
                    tiles[path_node.x][path_node.y] = texture;
                }
            },
            orthoToIsometric: function (x, y, half_width, half_height, offset_x, offset_y) {
                var u = (x - y) * half_width + offset_x;
                var v = (x + y) * half_height + offset_y;
                var w = x + y;
                return {x: u, y: v, z: w};
            },
            isometricToOrtho: function (u, v, half_width, half_height, offset_x, offset_y, sprite_anchor) {
                var _u = (u - offset_x) / half_width;
                var _v = (v - offset_y ) / half_height;

                var x = Math.floor(((_u + _v ) / 2) + sprite_anchor);
                var y = Math.floor(((_v - _u ) / 2) + sprite_anchor);
                return {x: x, y: y};
            },
            animate: function() {
                if(Generator.frame_count % 10 == 0){
                    var diff = (Date.now() - Generator.time) / 1000;
                    Generator.text.fps.setText(Math.round(1 / diff) + ' fps');
                }
                requestAnimFrame(Generator.lib.animate);

                // render the stage
                Generator.renderer.render(Generator.stage);
                Generator.time = Date.now();
                Generator.frame_count++;
            }
        }
    };

    $(document).ready(function(){
        Generator.init({});
    });

</script>
</body>
</html>